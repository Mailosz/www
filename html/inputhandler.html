<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input handler</title>
    <style>
        .input-box {
            background: rgba(127, 127, 127, 0.1);
            border: 1px solid black;
            padding: 4px;
            min-height: 200px;
        }

        @keyframes caret-blinking {
            0% {background-color: transparent;}
            100% {background-color: black;}
        }

        p {
            padding: 10px;
            margin: 10px;
            background-color: darkseagreen;
        }
        .input-box div {
            padding: 10px;
            background-color: aquamarine;;
            margin: 10px;
        }

        .input-box span {
            padding: 4px;
            background-color: lightpink;;
            margin: 4px;
        }

        .selection {
            outline: 2px solid red;
            min-width: 1px;
            z-index: 10000;
        }
        .selection.caret {
            outline: 2px solid orange;
            background-color: black;
            animation: caret-blinking 500ms alternate infinite;
        }
        .selection.end {
            outline: 2px dotted blue;

        }
        .selection.start {
            outline: 2px dotted green;
        }
        .selection.between {
            outline: 2px solid black;
        }

        .selected-element, .selection.element {
            outline-offset: 2px;
            outline: 2px dashed red;
        }

        #node-tree {
            border: 1px solid black;
            padding: 10px;
        }

        #node-tree div.node-element {
            padding: 0.25em 0 0.25em 1em;
            min-height: 1.5em;
        }

        #node-tree div.node-element:hover:not(:has(.node-element:hover)) {
            background-color: #eee;
        }

        #node-tree .selection-start {
            background-color: #dff6fe;
        }

        #node-tree .selection-start::before {
            content: attr(offset-start);
            margin-right: 1em;
        }

        #node-tree .selection-end {
            background-color: #ffaa77;
        }

        #node-tree .selection-end::after {
            content: attr(offset-end);
            margin-left: 1em;
        }

        #node-tree .selection-start.selection-end {
            background-color: #88ee77;
        }
    </style>
    <script type="module" src="../js/ui/controls/OxCode.js"></script>
</head>
<body>
    <div>
        <div id="test-elem" style="display: inline flex;"></div>
    </div>
<button id="test-button">Test</button>
<button id="undo-button">Undo</button>
<button id="redo-button">Redo</button>
    &emsp;
<button id="insert-inline-button">Insert inline</button>
<button id="insert-block-button">Insert block</button>
<div id="input-1" class="input-box input-handler" contenteditable="true"><h1>Title</h1><h2>subtitle</h2><div><p>qwertyu<span>iop[asd</span>fgh<span>jkl;</span>zxcvbnm</p><p>qwertyu<span>iop[</span><span>asd</span>fghjkl;zxcvbnm<span><span>test</span></span></p>abcd<p>qwertyuiop<span></span>[asdfghjkl;zxcvbnm</p></div></div>
<br>
    <div id="node-tree"></div>

<!--<div id="input-2" class="input-box" contenteditable="true">-->
<!--    <div class="test"><div>test</div>cbf</div>-->
<!--    <div class="text">Text 2 tst</div>-->
<!--    <p>111111</p>-->
<!--    <p>222222</p>-->
<!--    <p>333333</p>-->
<!--    <p>444444</p>-->
<!--</div>-->

<script type="module">
    import {handleInput, handleKeyDown, handlePointerDown, handlePointerMove, handlePointerUp} from "../js/inputhandler/InputHandler.js";
    import {MutationUndoer} from "../js/utils/MutationUndoer.js";

    document.onselectionchange = (event) => {
        updateSelection(document.getSelection());
    }

    let p = document.createElement("p");
    let options = {
        paragraph: p
    };

    let input = document.getElementById("input-1");
    let target = document.getElementById("node-tree");

    document.body.onload = () => {
        print();
    }

    function print() {
        if (target != null) {
            target.innerHTML = "";
            printNodeTree(input, target);
        }
    }

    document.querySelectorAll("#input-1").forEach((element) => {
        element.onbeforeinput = handleInput(options);
        element.oninput = (event) => {
            print();
        }

        element.onkeydown = handleKeyDown;
        element.onmousedown = (event) => event.preventDefault();
        element.onmouseup = (event) => event.preventDefault();
        element.onpointerdown = handlePointerDown;
        element.onpointermove = handlePointerMove;
        element.onpointerup = handlePointerUp;

    });


    document.querySelectorAll("#input-2").forEach((element) => {
        element.onbeforeinput = handleInput(options);
    });


    let button = document.querySelector("#test-button");

    button.onclick = (event) => {
        
    }

    // let element = document.querySelector("#test-elem")
    // // let element = button;

    // let style = getComputedStyle(element);//Array.from(element.computedStyleMap().entries());

    // console.log(style.display);
    // console.log(style);

    // document.onselectionchange = (event) => {
    //     console.log(event);
    // }
    const ce = document.getElementById("input-1");
    const mutationUndoer = new MutationUndoer(ce, {});
    mutationUndoer.startRecording();

    let sourceCodeBox = document.getElementById("source-code");
    ce.addEventListener("input", (event) => {
        console.log("y");
       mutationUndoer.startRecording();
       //  sourceCodeBox.setCode(ce.innerHTML);
    });

    document.getElementById("undo-button").onclick = () => {
        mutationUndoer.undo();
    };

    document.getElementById("redo-button").onclick = () => {
        mutationUndoer.redo();
    };

    document.getElementById("insert-inline-button").onclick = () => {
        mutationUndoer.undo();
    };

    document.getElementById("insert-block-button").onclick = () => {
        mutationUndoer.undo();
    };

    /**
     *
     * @param {HTMLElement} root
     * @param {HTMLElement} target
     */
    function printNodeTree(root, target) {
        if (root != null) {
            let node = printNode(root);
            target.appendChild(node);

            let child = root.firstChild;
            while (child != null) {
                printNodeTree(child, node)
                child = child.nextSibling;
            }
        }
    }

    /**
     *
     * @param {Node} node
     */
    function printNode(node) {
        let div = document.createElement("div");
        if (node.nodeType === Node.TEXT_NODE) {
            div.innerText = node.textContent;
        } else {
            div.innerText = "<" + node.nodeName.toLowerCase() + ">";
        }
        div.nodeRef = node;
        div.classList.add("node-element");
        node.nodeRef = div;

        return div;
    }

    /**
     *
     * @param {Selection} selection
     */
    function updateSelection(selection) {

        document.querySelectorAll(".selection-start").forEach((element) => {element.classList.remove("selection-start");});
        document.querySelectorAll(".selection-end").forEach((element) => {element.classList.remove("selection-end");});
        document.querySelectorAll(".selected-element").forEach((e)=>e.classList.remove("selected-element"));

        for (let i = 0; i < selection.rangeCount; i++) {

            let range = selection.getRangeAt(i)

            updateSelectionRange(range);
        }

    }

    /**
     *
     * @param {Range} range
     */
    function updateSelectionRange(range) {

        let element = range.commonAncestorContainer;
        if (element.nodeType === Node.ELEMENT_NODE) {
            // let node = element.childNodes.item(range.st)
            element.classList.add("selected-element");
        }

        let start = range.startContainer.nodeRef;
        if (start) {
            start.classList.add("selection-start");
            start.setAttribute("offset-start", range.startOffset);
        }

        let end = range.endContainer.nodeRef;
        if (end) {
            end.classList.add("selection-end");
            end.setAttribute("offset-end", range.endOffset);
        }
    }

</script>
</body>
</html>